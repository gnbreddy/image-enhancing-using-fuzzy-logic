<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Fuzzy Logic Image Enhancer</title>
    <!-- Simple favicon to prevent 404 errors -->
    <link
      rel="icon"
      href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üñºÔ∏è</text></svg>"
    />
    <!-- Tailwind CSS CDN for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
      body {
        font-family: "Inter", sans-serif;
        background-color: #f3f4f6;
      }
      canvas {
        border: 2px solid #e5e7eb;
        border-radius: 0.5rem;
        max-width: 100%;
        height: auto;
        background-color: #fff;
      }
    </style>
  </head>
  <body class="bg-gray-100 flex items-center justify-center min-h-screen p-4">
    <div class="bg-white p-8 rounded-2xl shadow-xl max-w-4xl w-full">
      <div class="flex items-center justify-between mb-6">
        <button onclick="window.location.href='../index.html'" class="bg-gray-500 hover:bg-gray-600 text-white font-semibold py-2 px-4 rounded-lg transition-colors duration-300">
          ‚Üê Back to Home
        </button>
        <h1 class="text-3xl font-bold text-gray-800">Fuzzy Logic Image Enhancer</h1>
        <div class="w-32"></div> <!-- Spacer for centering -->
      </div>

      <div class="space-y-4 mb-6">
        <div class="flex flex-col items-center">
          <label
            for="image-upload"
            class="bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2 px-6 rounded-lg cursor-pointer transition-colors duration-300"
          >
            Upload Image
          </label>
          <input
            type="file"
            id="image-upload"
            accept="image/*"
            class="hidden"
          />
          <p id="file-name" class="mt-2 text-gray-600 text-sm"></p>
        </div>
        <button
          id="process-btn"
          class="w-full bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-6 rounded-lg transition-colors duration-300 shadow-lg"
          disabled
        >
          Enhance Contrast
        </button>
      </div>

      <div id="loading-indicator" class="hidden text-center text-gray-500 mb-4">
        Processing image...
      </div>

      <div class="grid md:grid-cols-2 gap-8">
        <div class="flex flex-col items-center">
          <h2 class="text-xl font-semibold mb-2">Original Image</h2>
          <canvas id="original-canvas"></canvas>
        </div>
        <div class="flex flex-col items-center">
          <h2 class="text-xl font-semibold mb-2">Processed Image</h2>
          <canvas id="processed-canvas"></canvas>
        </div>
      </div>
      
      <!-- Download Section -->
      <div id="download-section" class="hidden mt-8 text-center">
        <button id="download-btn" class="bg-purple-500 hover:bg-purple-600 text-white font-bold py-3 px-8 rounded-lg transition-colors duration-300 shadow-lg">
          üì• Download Enhanced Image
        </button>
        <p class="mt-2 text-gray-600 text-sm">Download your contrast-enhanced image</p>
      </div>
    </div>

    <script>
      // Get references to all the DOM elements
      const imageUpload = document.getElementById("image-upload");
      const fileNameDisplay = document.getElementById("file-name");
      const processBtn = document.getElementById("process-btn");
      const originalCanvas = document.getElementById("original-canvas");
      const processedCanvas = document.getElementById("processed-canvas");
      const loadingIndicator = document.getElementById("loading-indicator");

      const originalCtx = originalCanvas.getContext("2d");
      const processedCtx = processedCanvas.getContext("2d");

      let originalImage = null;

      // Event listener for the file input
      imageUpload.addEventListener("change", (event) => {
        const file = event.target.files[0];
        if (file) {
          fileNameDisplay.textContent = file.name;
          processBtn.disabled = true; // Disable button until image is loaded

          const reader = new FileReader();
          reader.onload = (e) => {
            originalImage = new Image();
            originalImage.onload = () => {
              // Set canvas sizes to match the image
              originalCanvas.width = originalImage.width;
              originalCanvas.height = originalImage.height;
              processedCanvas.width = originalImage.width;
              processedCanvas.height = originalImage.height;

              // Draw the original image on the canvas
              originalCtx.drawImage(originalImage, 0, 0);
              processedCtx.clearRect(
                0,
                0,
                processedCanvas.width,
                processedCanvas.height
              ); // Clear processed canvas
              processBtn.disabled = false; // Enable button once image is loaded
            };
            originalImage.src = e.target.result;
          };
          reader.readAsDataURL(file);
        }
      });

      // Event listener for the process button
      processBtn.addEventListener("click", () => {
        if (originalImage) {
          loadingIndicator.classList.remove("hidden");
          processBtn.disabled = true;

          // Use a small delay to allow the loading message to appear
          setTimeout(() => {
            processImage();
            loadingIndicator.classList.add("hidden");
            processBtn.disabled = false;
          }, 100);
        }
      });

      // Event listener for the download button
      document.getElementById('download-btn').addEventListener('click', () => {
        const link = document.createElement('a');
        link.download = 'contrast_enhanced_image.png';
        link.href = processedCanvas.toDataURL();
        link.click();
      });

      /**
       * Main function to process the image using fuzzy logic.
       */
      function processImage() {
        // Get the image data from the original canvas
        const imageData = originalCtx.getImageData(
          0,
          0,
          originalCanvas.width,
          originalCanvas.height
        );
        const data = imageData.data;

        // Loop through each pixel
        for (let i = 0; i < data.length; i += 4) {
          // Get the grayscale value of the current pixel (assuming a grayscale or RGB image)
          const gray = (data[i] + data[i + 1] + data[i + 2]) / 3;

          // Apply the fuzzy logic system to get a new pixel value
          const enhancedGray = fuzzyEnhance(gray);

          // Set the new pixel values for RGB channels
          data[i] = enhancedGray; // R
          data[i + 1] = enhancedGray; // G
          data[i + 2] = enhancedGray; // B
        }

        // Put the processed image data back onto the processed canvas
        processedCtx.putImageData(imageData, 0, 0);
        
        // Show download section
        document.getElementById('download-section').classList.remove('hidden');
      }

      /**
       * The core fuzzy logic system for contrast enhancement.
       * It takes a pixel's intensity (0-255) and returns a new enhanced intensity.
       * * @param {number} intensity - The grayscale intensity of a pixel (0-255).
       * @returns {number} The new, enhanced pixel intensity.
       */
      function fuzzyEnhance(intensity) {
        // --- Fuzzification: Determine the degree of membership for each fuzzy set ---

        // Fuzzy Sets for the input intensity: 'Dark', 'Medium', 'Bright'
        // We use triangular and trapezoidal membership functions.
        const darkMembership = trapezoidalMembership(intensity, 0, 0, 85, 127);
        const mediumMembership = triangularMembership(intensity, 85, 127, 170);
        const brightMembership = trapezoidalMembership(
          intensity,
          127,
          170,
          255,
          255
        );

        // --- Fuzzy Rule Base and Inference ---

        // Define the fuzzy output values for each rule.
        // Optimized output values for screenshots and digital images
        // Rule 1: IF intensity is DARK THEN enhanced is DARKER (preserve shadow details)
        // Rule 2: IF intensity is MEDIUM THEN enhanced is ENHANCED_MEDIUM (boost mid-tones)
        // Rule 3: IF intensity is BRIGHT THEN enhanced is BRIGHTER (preserve highlights)
        const veryDarkOutput = 25;   // Slightly brighter than pure black for detail
        const mediumOutput = 140;    // Enhanced medium tones for better contrast
        const veryBrightOutput = 230; // Preserve bright details, avoid clipping

        // Apply the rules and get the weighted sum of outputs
        const numerator =
          darkMembership * veryDarkOutput +
          mediumMembership * mediumOutput +
          brightMembership * veryBrightOutput;

        // Get the sum of the degrees of membership (weights)
        const denominator =
          darkMembership + mediumMembership + brightMembership;

        // --- Defuzzification: Use the weighted average method ---
        let enhancedIntensity = 0;
        if (denominator !== 0) {
          enhancedIntensity = numerator / denominator;
        }

        // Clamp the result to be within the valid range (0-255)
        return Math.min(255, Math.max(0, enhancedIntensity));
      }

      /**
       * Calculates the degree of membership for a triangular fuzzy set.
       * @param {number} x - The input value.
       * @param {number} a - The lower bound.
       * @param {number} m - The peak of the triangle.
       * @param {number} b - The upper bound.
       * @returns {number} The degree of membership (0-1).
       */
      function triangularMembership(x, a, m, b) {
        if (x <= a || x >= b) {
          return 0;
        } else if (x >= a && x <= m) {
          return (x - a) / (m - a);
        } else if (x >= m && x <= b) {
          return (b - x) / (b - m);
        }
        return 0;
      }

      /**
       * Calculates the degree of membership for a trapezoidal fuzzy set.
       * @param {number} x - The input value.
       * @param {number} a - The lower bound of the base.
       * @param {number} m1 - The lower bound of the top.
       * @param {number} m2 - The upper bound of the top.
       * @param {number} b - The upper bound of the base.
       * @returns {number} The degree of membership (0-1).
       */
      function trapezoidalMembership(x, a, m1, m2, b) {
        if (x <= a || x >= b) {
          return 0;
        } else if (x >= m1 && x <= m2) {
          return 1;
        } else if (x > a && x < m1) {
          return (x - a) / (m1 - a);
        } else if (x > m2 && x < b) {
          return (b - x) / (b - m2);
        }
        return 0;
      }
    </script>
  </body>
</html>
